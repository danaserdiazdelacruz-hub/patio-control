<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - Log√≠stica</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">üöõ</div>
        <div class="logo-text">
          Control de Patio
          <span>Centro de Distribuci√≥n</span>
        </div>
      </div>
      
      <nav>
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a class="nav-item active" data-view="dashboard">
            <span class="nav-item-icon">üìä</span>
            Dashboard
          </a>
          <a class="nav-item" data-view="rampas">
            <span class="nav-item-icon">üÖøÔ∏è</span>
            Rampas
          </a>
          <a class="nav-item" data-view="cola">
            <span class="nav-item-icon">üöö</span>
            Cola de Camiones
          </a>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Administraci√≥n</div>
          <a class="nav-item" data-view="usuarios">
            <span class="nav-item-icon">üë•</span>
            Usuarios
          </a>
          <a class="nav-item" data-view="camiones">
            <span class="nav-item-icon">üöõ</span>
            Camiones
          </a>
          <a class="nav-item" data-view="reportes">
            <span class="nav-item-icon">üìà</span>
            Reportes
          </a>
        </div>
      </nav>
      
      <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div class="nav-item" id="userInfo" style="cursor: default;">
          <span class="nav-item-icon">üë§</span>
          <span id="userName">Usuario</span>
        </div>
        <button class="btn btn-ghost btn-sm" style="width: 100%; margin-top: 0.5rem;" onclick="logout()">
          Cerrar Sesi√≥n
        </button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <div id="view-dashboard" class="view-content">
        <div class="page-header">
          <h1 class="page-title">Dashboard <span>¬∑ Tiempo Real</span></h1>
          <div class="flex gap-2">
            <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">
              üîÑ Actualizar
            </button>
            <button class="btn btn-primary" onclick="openModal('modalIngreso')">
              + Registrar Ingreso
            </button>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-label">En Patio</div>
            <div class="stat-value" id="statEnPatio">0</div>
          </div>
          <div class="stat-card highlight-green">
            <div class="stat-label">Disponibles</div>
            <div class="stat-value green" id="statDisponibles">0</div>
          </div>
          <div class="stat-card highlight-blue">
            <div class="stat-label">En Rampa</div>
            <div class="stat-value blue" id="statEnRampa">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Rampas Libres</div>
            <div class="stat-value" id="statRampasLibres">0</div>
            <div class="stat-detail">de <span id="statRampasTotal">0</span> totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tiempo Prom. Espera</div>
            <div class="stat-value yellow" id="statTiempoEspera">--</div>
            <div class="stat-detail">minutos</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tiempo Prom. Rampa</div>
            <div class="stat-value" id="statTiempoRampa">--</div>
            <div class="stat-detail">minutos</div>
          </div>
        </div>
        
        <!-- Rampas Grid -->
        <h2 style="font-size: 1.1rem; margin-bottom: 1rem;">Estado de Rampas</h2>
        <div class="rampas-grid" id="rampasGrid">
          <!-- Se llena din√°micamente -->
        </div>
        
        <!-- Cola R√°pida -->
        <div class="cola-section">
          <div class="cola-title">
            <span>üöö Camiones Disponibles</span>
            <span class="cola-count" id="colaCount">0</span>
          </div>
          <div class="camion-list" id="colaDisponibles">
            <!-- Se llena din√°micamente -->
          </div>
        </div>
      </div>
      
      <!-- Rampas View -->
      <div id="view-rampas" class="view-content hidden">
        <div class="page-header">
          <h1 class="page-title">Gesti√≥n de Rampas</h1>
          <button class="btn btn-primary" onclick="openModal('modalRampa')">
            + Nueva Rampa
          </button>
        </div>
        <div class="rampas-grid" id="rampasFullGrid"></div>
      </div>
      
      <!-- Cola View -->
      <div id="view-cola" class="view-content hidden">
        <div class="page-header">
          <h1 class="page-title">Cola de Camiones</h1>
          <button class="btn btn-primary" onclick="openModal('modalIngreso')">
            + Registrar Ingreso
          </button>
        </div>
        
        <div class="tabs">
          <button class="tab active" data-tab="disponibles">Disponibles</button>
          <button class="tab" data-tab="solicitados">Solicitados</button>
          <button class="tab" data-tab="en-camino">En Camino</button>
          <button class="tab" data-tab="historial">Historial Hoy</button>
        </div>
        
        <div id="tab-disponibles" class="tab-content">
          <div class="camion-list" id="listaDisponibles"></div>
        </div>
        <div id="tab-solicitados" class="tab-content hidden">
          <div class="camion-list" id="listaSolicitados"></div>
        </div>
        <div id="tab-en-camino" class="tab-content hidden">
          <div class="camion-list" id="listaEnCamino"></div>
        </div>
        <div id="tab-historial" class="tab-content hidden">
          <div class="table-container">
            <table class="table" id="tablaHistorial">
              <thead>
                <tr>
                  <th>Placa</th>
                  <th>Chofer</th>
                  <th>Rampa</th>
                  <th>Ingreso</th>
                  <th>En Rampa</th>
                  <th>Salida</th>
                  <th>T. Total</th>
                </tr>
              </thead>
              <tbody id="historialBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Usuarios View -->
      <div id="view-usuarios" class="view-content hidden">
        <div class="page-header">
          <h1 class="page-title">Usuarios del Sistema</h1>
          <button class="btn btn-primary" onclick="openModal('modalUsuario')">
            + Nuevo Usuario
          </button>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Tel√©fono</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="usuariosBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Camiones View -->
      <div id="view-camiones" class="view-content hidden">
        <div class="page-header">
          <h1 class="page-title">Flota de Camiones</h1>
          <button class="btn btn-primary" onclick="openModal('modalCamion')">
            + Nuevo Cami√≥n
          </button>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Chofer Asignado</th>
                <th>Capacidad</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="camionesBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Reportes View -->
      <div id="view-reportes" class="view-content hidden">
        <div class="page-header">
          <h1 class="page-title">Reportes</h1>
        </div>
        <p class="text-muted">Pr√≥ximamente: Reportes exportables a Excel/PDF</p>
      </div>
    </main>
  </div>
  
  <!-- Modal: Registrar Ingreso -->
  <div class="modal-overlay" id="modalIngreso">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Registrar Ingreso</h3>
        <button class="modal-close" onclick="closeModal('modalIngreso')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formIngreso">
          <div class="form-group">
            <label class="form-label">Placa del Cami√≥n</label>
            <select id="ingresoPlaca" class="form-select" required>
              <option value="">Seleccionar cami√≥n...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">C√≥digo del Chofer</label>
            <select id="ingresoChofer" class="form-select" required>
              <option value="">Seleccionar chofer...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalIngreso')">Cancelar</button>
        <button class="btn btn-primary" onclick="registrarIngreso()">Registrar Ingreso</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Asignar Rampa -->
  <div class="modal-overlay" id="modalAsignar">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Asignar Rampa</h3>
        <button class="modal-close" onclick="closeModal('modalAsignar')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background: var(--bg-dark); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div class="text-muted" style="font-size: 0.8rem;">Cami√≥n seleccionado</div>
          <div class="mono" style="font-size: 1.25rem; font-weight: 600;" id="asignarPlaca">--</div>
          <div class="text-secondary" style="font-size: 0.85rem;" id="asignarChofer">--</div>
        </div>
        <form id="formAsignar">
          <input type="hidden" id="asignarMovimientoId">
          <div class="form-group">
            <label class="form-label">Rampa</label>
            <select id="asignarRampa" class="form-select" required>
              <option value="">Seleccionar rampa...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <input type="text" id="asignarNotas" class="form-input" placeholder="Ej: Descarga r√°pida">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalAsignar')">Cancelar</button>
        <button class="btn btn-primary" onclick="asignarRampa()">Asignar Rampa</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Nuevo Usuario -->
  <div class="modal-overlay" id="modalUsuario">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Nuevo Usuario</h3>
        <button class="modal-close" onclick="closeModal('modalUsuario')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formUsuario">
          <div class="form-group">
            <label class="form-label">C√≥digo</label>
            <input type="text" id="usuarioCodigo" class="form-input" placeholder="Ej: CHO004" required>
          </div>
          <div class="form-group">
            <label class="form-label">Nombre Completo</label>
            <input type="text" id="usuarioNombre" class="form-input" placeholder="Nombre del usuario" required>
          </div>
          <div class="form-group">
            <label class="form-label">PIN (4 d√≠gitos)</label>
            <input type="password" id="usuarioPin" class="form-input" placeholder="1234" maxlength="4" required>
          </div>
          <div class="form-group">
            <label class="form-label">Rol</label>
            <select id="usuarioRol" class="form-select" required>
              <option value="chofer">Chofer</option>
              <option value="despacho">Despacho</option>
              <option value="logistica">Log√≠stica</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Tel√©fono (opcional)</label>
            <input type="text" id="usuarioTelefono" class="form-input" placeholder="809-555-0000">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalUsuario')">Cancelar</button>
        <button class="btn btn-primary" onclick="crearUsuario()">Crear Usuario</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Nuevo Cami√≥n -->
  <div class="modal-overlay" id="modalCamion">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Nuevo Cami√≥n</h3>
        <button class="modal-close" onclick="closeModal('modalCamion')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formCamion">
          <div class="form-group">
            <label class="form-label">Placa</label>
            <input type="text" id="camionPlaca" class="form-input" placeholder="Ej: A123456" required>
          </div>
          <div class="form-group">
            <label class="form-label">Tipo</label>
            <select id="camionTipo" class="form-select" required>
              <option value="seco">Seco</option>
              <option value="refrigerado">Refrigerado</option>
              <option value="mixto">Mixto</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Capacidad (opcional)</label>
            <input type="text" id="camionCapacidad" class="form-input" placeholder="Ej: 10 toneladas">
          </div>
          <div class="form-group">
            <label class="form-label">Chofer Asignado (opcional)</label>
            <select id="camionChofer" class="form-select">
              <option value="">Sin asignar</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalCamion')">Cancelar</button>
        <button class="btn btn-primary" onclick="crearCamion()">Crear Cami√≥n</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Nueva Rampa -->
  <div class="modal-overlay" id="modalRampa">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Nueva Rampa</h3>
        <button class="modal-close" onclick="closeModal('modalRampa')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="formRampa">
          <div class="form-group">
            <label class="form-label">N√∫mero</label>
            <input type="number" id="rampaNumero" class="form-input" placeholder="Ej: 7" required>
          </div>
          <div class="form-group">
            <label class="form-label">Nombre (opcional)</label>
            <input type="text" id="rampaNombre" class="form-input" placeholder="Ej: Rampa 7 - Secos">
          </div>
          <div class="form-group">
            <label class="form-label">Tipo Permitido</label>
            <select id="rampaTipo" class="form-select">
              <option value="">Cualquier tipo</option>
              <option value="seco">Solo Secos</option>
              <option value="refrigerado">Solo Refrigerados</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal('modalRampa')">Cancelar</button>
        <button class="btn btn-primary" onclick="crearRampa()">Crear Rampa</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '';
    let ws = null;
    let usuario = null;
    let refreshInterval = null;
    
    // ========================================
    // INICIALIZACI√ìN
    // ========================================
    
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar sesi√≥n
      const userStr = localStorage.getItem('usuario');
      if (!userStr) {
        window.location.href = '/';
        return;
      }
      
      usuario = JSON.parse(userStr);
      document.getElementById('userName').textContent = usuario.nombre;
      
      // Setup navegaci√≥n
      setupNavigation();
      setupTabs();
      
      // Cargar datos iniciales
      loadDashboard();
      
      // WebSocket
      connectWebSocket();
      
      // Auto-refresh cada 30 segundos
      refreshInterval = setInterval(loadDashboard, 30000);
    });
    
    function logout() {
      localStorage.removeItem('usuario');
      if (ws) ws.close();
      if (refreshInterval) clearInterval(refreshInterval);
      window.location.href = '/';
    }
    
    // ========================================
    // NAVEGACI√ìN
    // ========================================
    
    function setupNavigation() {
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', () => {
          const viewId = item.dataset.view;
          
          // Actualizar nav activo
          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          
          // Mostrar vista
          document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
          document.getElementById(`view-${viewId}`).classList.remove('hidden');
          
          // Cargar datos de la vista
          loadViewData(viewId);
        });
      });
    }
    
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        });
      });
    }
    
    function loadViewData(viewId) {
      switch(viewId) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'rampas':
          loadRampas();
          break;
        case 'cola':
          loadCola();
          break;
        case 'usuarios':
          loadUsuarios();
          break;
        case 'camiones':
          loadCamiones();
          break;
      }
    }
    
    // ========================================
    // WEBSOCKET
    // ========================================
    
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws/${usuario.id}`);
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('WS:', data);
        
        // Recargar datos seg√∫n el tipo de mensaje
        if (['nuevo_ingreso', 'camion_disponible', 'solicitud_camion', 'chofer_confirmo', 
             'camion_en_rampa', 'rampa_liberada'].includes(data.tipo)) {
          loadDashboard();
        }
      };
      
      ws.onclose = () => {
        console.log('WebSocket cerrado, reconectando...');
        setTimeout(connectWebSocket, 3000);
      };
    }
    
    // ========================================
    // DASHBOARD
    // ========================================
    
    async function loadDashboard() {
      try {
        // Estad√≠sticas
        const stats = await fetch(`${API_URL}/api/estadisticas`).then(r => r.json());
        document.getElementById('statEnPatio').textContent = stats.camiones_en_patio;
        document.getElementById('statDisponibles').textContent = stats.camiones_disponibles;
        document.getElementById('statEnRampa').textContent = stats.camiones_en_rampa;
        document.getElementById('statRampasLibres').textContent = stats.rampas_libres;
        document.getElementById('statRampasTotal').textContent = stats.rampas_libres + stats.rampas_ocupadas;
        document.getElementById('statTiempoEspera').textContent = stats.tiempo_promedio_espera 
          ? stats.tiempo_promedio_espera.toFixed(1) : '--';
        document.getElementById('statTiempoRampa').textContent = stats.tiempo_promedio_rampa 
          ? stats.tiempo_promedio_rampa.toFixed(1) : '--';
        
        // Rampas
        const rampas = await fetch(`${API_URL}/api/rampas/resumen`).then(r => r.json());
        renderRampas(rampas, 'rampasGrid');
        
        // Cola
        const cola = await fetch(`${API_URL}/api/movimientos/activos`).then(r => r.json());
        document.getElementById('colaCount').textContent = cola.disponibles.length;
        renderCola(cola.disponibles, 'colaDisponibles', true);
        
      } catch (error) {
        console.error('Error cargando dashboard:', error);
      }
    }
    
    function renderRampas(rampas, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = rampas.map(r => {
        const ocupada = r.rampa.estado === 'ocupada';
        const mov = r.movimiento_actual;
        
        return `
          <div class="rampa-card ${r.rampa.estado}">
            <div class="rampa-header">
              <span class="rampa-numero">R${r.rampa.numero}</span>
              <span class="rampa-estado ${r.rampa.estado}">${r.rampa.estado}</span>
            </div>
            <div class="rampa-info">${r.rampa.nombre || `Rampa ${r.rampa.numero}`}</div>
            ${ocupada && mov ? `
              <div class="rampa-camion">
                <div class="rampa-camion-placa">${mov.camion?.placa || '--'}</div>
                <div class="text-secondary" style="font-size: 0.8rem;">${mov.camion?.chofer?.nombre || 'Sin chofer'}</div>
                <div class="rampa-tiempo">
                  ‚è±Ô∏è ${r.tiempo_ocupada ? r.tiempo_ocupada.toFixed(0) : '0'} min
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function renderCola(movimientos, containerId, showAsignar = false) {
      const container = document.getElementById(containerId);
      
      if (movimientos.length === 0) {
        container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">No hay camiones</p>';
        return;
      }
      
      container.innerHTML = movimientos.map((m, i) => {
        const tiempoEspera = calcularTiempoEspera(m.hora_disponible_patio || m.hora_ingreso_garita);
        const alertaTiempo = tiempoEspera > 30;
        
        return `
          <div class="camion-card" data-id="${m.id}">
            <div class="camion-orden">${i + 1}</div>
            <div class="camion-info">
              <div class="camion-placa">${m.camion?.placa || '--'}</div>
              <div class="camion-detalle">
                <span>${m.camion?.chofer?.nombre || 'Sin chofer'}</span>
                <span class="badge badge-tipo">${m.camion?.tipo || '--'}</span>
                ${m.prioridad !== 'normal' ? `<span class="badge badge-urgente">${m.prioridad}</span>` : ''}
              </div>
            </div>
            <div class="camion-tiempo ${alertaTiempo ? 'alerta' : ''}">
              ‚è±Ô∏è ${tiempoEspera} min
            </div>
            ${showAsignar ? `
              <div class="camion-actions">
                <button class="btn btn-primary btn-sm" onclick="openAsignarModal(${m.id}, '${m.camion?.placa}', '${m.camion?.chofer?.nombre || 'Sin chofer'}')">
                  Asignar Rampa
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function calcularTiempoEspera(horaInicio) {
      if (!horaInicio) return 0;
      const inicio = new Date(horaInicio);
      const ahora = new Date();
      return Math.floor((ahora - inicio) / 60000);
    }
    
    // ========================================
    // COLA DE CAMIONES
    // ========================================
    
    async function loadCola() {
      try {
        const cola = await fetch(`${API_URL}/api/movimientos/activos`).then(r => r.json());
        
        renderCola(cola.disponibles, 'listaDisponibles', true);
        renderCola(cola.solicitados, 'listaSolicitados', true);
        renderCola(cola.en_camino, 'listaEnCamino', false);
        
        // Historial
        const hoy = new Date().toISOString().split('T')[0];
        const historial = await fetch(`${API_URL}/api/movimientos?fecha=${hoy}&limit=50`).then(r => r.json());
        renderHistorial(historial);
        
      } catch (error) {
        console.error('Error cargando cola:', error);
      }
    }
    
    function renderHistorial(movimientos) {
      const tbody = document.getElementById('historialBody');
      tbody.innerHTML = movimientos.map(m => {
        const tiempoTotal = m.hora_salida_rampa && m.hora_ingreso_garita
          ? calcularDiferencia(m.hora_ingreso_garita, m.hora_salida_rampa)
          : '--';
        
        return `
          <tr>
            <td class="mono">${m.camion?.placa || '--'}</td>
            <td>${m.camion?.chofer?.nombre || '--'}</td>
            <td>${m.rampa ? `R${m.rampa.numero}` : '--'}</td>
            <td>${formatHora(m.hora_ingreso_garita)}</td>
            <td>${formatHora(m.hora_en_rampa)}</td>
            <td>${formatHora(m.hora_salida_rampa)}</td>
            <td class="mono">${tiempoTotal}</td>
          </tr>
        `;
      }).join('');
    }
    
    function calcularDiferencia(inicio, fin) {
      const diff = Math.floor((new Date(fin) - new Date(inicio)) / 60000);
      return `${diff} min`;
    }
    
    function formatHora(fecha) {
      if (!fecha) return '--';
      return new Date(fecha).toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
    }
    
    // ========================================
    // RAMPAS
    // ========================================
    
    async function loadRampas() {
      const rampas = await fetch(`${API_URL}/api/rampas/resumen`).then(r => r.json());
      renderRampas(rampas, 'rampasFullGrid');
    }
    
    async function crearRampa() {
      const data = {
        numero: parseInt(document.getElementById('rampaNumero').value),
        nombre: document.getElementById('rampaNombre').value || null,
        tipo_permitido: document.getElementById('rampaTipo').value || null
      };
      
      try {
        await fetch(`${API_URL}/api/rampas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        closeModal('modalRampa');
        document.getElementById('formRampa').reset();
        loadRampas();
        loadDashboard();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear rampa');
      }
    }
    
    // ========================================
    // USUARIOS
    // ========================================
    
    async function loadUsuarios() {
      const usuarios = await fetch(`${API_URL}/api/usuarios`).then(r => r.json());
      const tbody = document.getElementById('usuariosBody');
      
      tbody.innerHTML = usuarios.map(u => `
        <tr>
          <td class="mono">${u.codigo}</td>
          <td>${u.nombre}</td>
          <td><span class="badge badge-tipo">${u.rol}</span></td>
          <td>${u.telefono || '--'}</td>
          <td><span class="badge ${u.activo ? 'badge-disponible' : 'badge-tipo'}">${u.activo ? 'Activo' : 'Inactivo'}</span></td>
          <td>
            <button class="btn btn-ghost btn-sm">Editar</button>
          </td>
        </tr>
      `).join('');
      
      // Llenar select de choferes para modal cami√≥n
      const choferes = usuarios.filter(u => u.rol === 'chofer');
      document.getElementById('camionChofer').innerHTML = '<option value="">Sin asignar</option>' +
        choferes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
      
      document.getElementById('ingresoChofer').innerHTML = '<option value="">Seleccionar chofer...</option>' +
        choferes.map(c => `<option value="${c.codigo}">${c.nombre} (${c.codigo})</option>`).join('');
    }
    
    async function crearUsuario() {
      const data = {
        codigo: document.getElementById('usuarioCodigo').value.toUpperCase(),
        nombre: document.getElementById('usuarioNombre').value,
        pin: document.getElementById('usuarioPin').value,
        rol: document.getElementById('usuarioRol').value,
        telefono: document.getElementById('usuarioTelefono').value || null
      };
      
      try {
        await fetch(`${API_URL}/api/usuarios`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        closeModal('modalUsuario');
        document.getElementById('formUsuario').reset();
        loadUsuarios();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear usuario');
      }
    }
    
    // ========================================
    // CAMIONES
    // ========================================
    
    async function loadCamiones() {
      const camiones = await fetch(`${API_URL}/api/camiones`).then(r => r.json());
      const tbody = document.getElementById('camionesBody');
      
      tbody.innerHTML = camiones.map(c => `
        <tr>
          <td class="mono">${c.placa}</td>
          <td><span class="badge badge-tipo">${c.tipo}</span></td>
          <td>${c.chofer?.nombre || '--'}</td>
          <td>${c.capacidad || '--'}</td>
          <td><span class="badge ${c.activo ? 'badge-disponible' : 'badge-tipo'}">${c.activo ? 'Activo' : 'Inactivo'}</span></td>
          <td>
            <button class="btn btn-ghost btn-sm">Editar</button>
          </td>
        </tr>
      `).join('');
      
      // Llenar select para modal ingreso
      document.getElementById('ingresoPlaca').innerHTML = '<option value="">Seleccionar cami√≥n...</option>' +
        camiones.map(c => `<option value="${c.placa}">${c.placa} - ${c.tipo}</option>`).join('');
    }
    
    async function crearCamion() {
      const data = {
        placa: document.getElementById('camionPlaca').value.toUpperCase(),
        tipo: document.getElementById('camionTipo').value,
        capacidad: document.getElementById('camionCapacidad').value || null,
        chofer_id: document.getElementById('camionChofer').value || null
      };
      
      try {
        await fetch(`${API_URL}/api/camiones`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        closeModal('modalCamion');
        document.getElementById('formCamion').reset();
        loadCamiones();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear cami√≥n');
      }
    }
    
    // ========================================
    // REGISTRAR INGRESO
    // ========================================
    
    async function registrarIngreso() {
      const placa = document.getElementById('ingresoPlaca').value;
      const chofer = document.getElementById('ingresoChofer').value;
      
      if (!placa || !chofer) {
        alert('Seleccione cami√≥n y chofer');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/api/movimientos/ingreso`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            placa: placa,
            chofer_codigo: chofer
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail);
        }
        
        const movimiento = await response.json();
        
        // Marcar como disponible inmediatamente
        await fetch(`${API_URL}/api/movimientos/${movimiento.id}/disponible`, {
          method: 'POST'
        });
        
        closeModal('modalIngreso');
        document.getElementById('formIngreso').reset();
        loadDashboard();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
      }
    }
    
    // ========================================
    // ASIGNAR RAMPA
    // ========================================
    
    async function openAsignarModal(movimientoId, placa, chofer) {
      document.getElementById('asignarMovimientoId').value = movimientoId;
      document.getElementById('asignarPlaca').textContent = placa;
      document.getElementById('asignarChofer').textContent = chofer;
      
      // Cargar rampas libres
      const rampas = await fetch(`${API_URL}/api/rampas?estado=libre`).then(r => r.json());
      document.getElementById('asignarRampa').innerHTML = '<option value="">Seleccionar rampa...</option>' +
        rampas.map(r => `<option value="${r.id}">Rampa ${r.numero} ${r.nombre ? `- ${r.nombre}` : ''}</option>`).join('');
      
      openModal('modalAsignar');
    }
    
    async function asignarRampa() {
      const movimientoId = document.getElementById('asignarMovimientoId').value;
      const rampaId = document.getElementById('asignarRampa').value;
      const notas = document.getElementById('asignarNotas').value;
      
      if (!rampaId) {
        alert('Seleccione una rampa');
        return;
      }
      
      try {
        await fetch(`${API_URL}/api/movimientos/asignar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            movimiento_id: parseInt(movimientoId),
            rampa_id: parseInt(rampaId),
            asignado_por_id: usuario.id,
            notas: notas || null
          })
        });
        
        closeModal('modalAsignar');
        document.getElementById('formAsignar').reset();
        loadDashboard();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al asignar rampa');
      }
    }
    
    // ========================================
    // MODALES
    // ========================================
    
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
      
      // Cargar datos seg√∫n el modal
      if (modalId === 'modalIngreso') {
        loadCamiones();
        loadUsuarios();
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // Cerrar modal con click fuera
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
    
    // Cerrar modal con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
      }
    });
  </script>
</body>
</html>
